"""
================================================================================
LangChain AI Agent ë§ˆìŠ¤í„° êµì•ˆ
Part 10: ë°°í¬ì™€ ê´€ì¸¡ì„± (Deployment & Observability)
================================================================================

íŒŒì¼ëª…: 01_langsmith_setup.py
ë‚œì´ë„: â­â­â­â­â˜† (ê³ ê¸‰)
ì˜ˆìƒ ì‹œê°„: 20ë¶„

ğŸ“š í•™ìŠµ ëª©í‘œ:
  - LangSmith ê°œë…ê³¼ í•„ìš”ì„± ì´í•´
  - LangSmith ê³„ì • ë° API í‚¤ ì„¤ì •
  - í”„ë¡œì íŠ¸ ë° ë°ì´í„°ì…‹ ìƒì„±
  - ê¸°ë³¸ íŠ¸ë ˆì´ì‹± í™œì„±í™”

ğŸ“– ê³µì‹ ë¬¸ì„œ:
  â€¢ LangSmith: /official/30-langsmith-studio.md
  â€¢ Testing: /official/31-test.md

ğŸ“„ êµì•ˆ ë¬¸ì„œ:
  â€¢ Part 10 ê°œìš”: /docs/part10_deployment.md

ğŸ”§ í•„ìš”í•œ íŒ¨í‚¤ì§€:
  pip install langchain langchain-openai langsmith

ğŸ”‘ í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜:
  - OPENAI_API_KEY
  - LANGSMITH_API_KEY (ì„ íƒ)

ğŸš€ ì‹¤í–‰ ë°©ë²•:
  python 01_langsmith_setup.py

================================================================================
"""

# ============================================================================
# Imports
# ============================================================================

import os
import sys
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from langchain.agents import create_agent
from langchain.tools import tool

# ============================================================================
# í™˜ê²½ ì„¤ì •
# ============================================================================

load_dotenv()

if not os.getenv("OPENAI_API_KEY"):
    print("âŒ ì˜¤ë¥˜: OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    sys.exit(1)

# ============================================================================
# ì˜ˆì œ 1: LangSmithë€?
# ============================================================================

def example_1_langsmith_intro():
    """LangSmith ì†Œê°œ"""
    print("=" * 70)
    print("ğŸ“Œ ì˜ˆì œ 1: LangSmithë€?")
    print("=" * 70)

    print("""
ğŸ” LangSmithë€?

ì •ì˜:
  LLM ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê°œë°œ, ëª¨ë‹ˆí„°ë§, í‰ê°€ë¥¼ ìœ„í•œ
  Anthropicì˜ í†µí•© í”Œë«í¼

ì£¼ìš” ê¸°ëŠ¥:
  1ï¸âƒ£ íŠ¸ë ˆì´ì‹± (Tracing)
     â€¢ Agent ì‹¤í–‰ ê³¼ì • ì¶”ì 
     â€¢ LLM í˜¸ì¶œ, Tool ì‚¬ìš© ê¸°ë¡
     â€¢ ì„±ëŠ¥ ë³‘ëª© ì§€ì  íŒŒì•…

  2ï¸âƒ£ í‰ê°€ (Evaluation)
     â€¢ ë°ì´í„°ì…‹ ê¸°ë°˜ í…ŒìŠ¤íŠ¸
     â€¢ ìë™ í‰ê°€ ë©”íŠ¸ë¦­
     â€¢ A/B í…ŒìŠ¤íŠ¸

  3ï¸âƒ£ ëª¨ë‹ˆí„°ë§ (Monitoring)
     â€¢ ì‹¤ì‹œê°„ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
     â€¢ ì˜¤ë¥˜ ì¶”ì 
     â€¢ ì‚¬ìš©ëŸ‰ ë¶„ì„

  4ï¸âƒ£ ë””ë²„ê¹… (Debugging)
     â€¢ ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
     â€¢ í”„ë¡¬í”„íŠ¸ ìµœì í™”
     â€¢ ë¹„ìš© ìµœì í™”

ì™œ í•„ìš”í•œê°€?
  âœ… íˆ¬ëª…ì„±: Agentê°€ ë¬´ì—‡ì„ í•˜ëŠ”ì§€ ì •í™•íˆ íŒŒì•…
  âœ… ë””ë²„ê¹…: ë¬¸ì œ ë°œìƒ ì‹œ ë¹ ë¥¸ ì›ì¸ íŒŒì•…
  âœ… ìµœì í™”: ì„±ëŠ¥ê³¼ ë¹„ìš© ê°œì„  í¬ì¸íŠ¸ ë°œê²¬
  âœ… í’ˆì§ˆ ê´€ë¦¬: ì§€ì†ì ì¸ í’ˆì§ˆ ì¸¡ì •

í”„ë¡œë•ì…˜ í•„ìˆ˜!
  ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” LangSmith ê°™ì€ ê´€ì¸¡ì„± ë„êµ¬ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤.
    """)


# ============================================================================
# ì˜ˆì œ 2: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# ============================================================================

def example_2_environment_setup():
    """LangSmith í™˜ê²½ ë³€ìˆ˜ ì„¤ì •"""
    print("\n" + "=" * 70)
    print("ğŸ“Œ ì˜ˆì œ 2: LangSmith í™˜ê²½ ë³€ìˆ˜ ì„¤ì •")
    print("=" * 70)

    print("""
ğŸ”§ LangSmith ì‹œì‘í•˜ê¸°:

1ï¸âƒ£ ê³„ì • ìƒì„±:
   https://smith.langchain.com ë°©ë¬¸
   â†’ ë¬´ë£Œ ê³„ì • ìƒì„±

2ï¸âƒ£ API í‚¤ ë°œê¸‰:
   Settings â†’ API Keys â†’ Create API Key

3ï¸âƒ£ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •:
   .env íŒŒì¼ì— ì¶”ê°€:
   ```
   LANGSMITH_API_KEY=lsv2_pt_...
   LANGSMITH_TRACING=true
   LANGSMITH_PROJECT=my-agent-project
   ```

4ï¸âƒ£ í™•ì¸:
   Agent ì‹¤í–‰ ì‹œ ìë™ìœ¼ë¡œ LangSmithì— íŠ¸ë ˆì´ìŠ¤ ì „ì†¡
    """)

    print("\nğŸ”¹ í˜„ì¬ í™˜ê²½ ë³€ìˆ˜ ìƒíƒœ:")
    print("-" * 70)

    langsmith_key = os.getenv("LANGSMITH_API_KEY")
    langsmith_tracing = os.getenv("LANGSMITH_TRACING", "false")
    langsmith_project = os.getenv("LANGSMITH_PROJECT", "default")

    if langsmith_key:
        masked_key = langsmith_key[:10] + "..." if len(langsmith_key) > 10 else "***"
        print(f"  âœ… LANGSMITH_API_KEY: {masked_key}")
        print(f"  âœ… LANGSMITH_TRACING: {langsmith_tracing}")
        print(f"  âœ… LANGSMITH_PROJECT: {langsmith_project}")
        print("\n  ğŸ‰ LangSmithê°€ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤!")
        print("     Agent ì‹¤í–‰ ì‹œ ìë™ìœ¼ë¡œ íŠ¸ë ˆì´ì‹±ë©ë‹ˆë‹¤.")
    else:
        print(f"  âšª LANGSMITH_API_KEY: ì„¤ì •ë˜ì§€ ì•ŠìŒ")
        print(f"  â„¹ï¸  LANGSMITH_TRACING: {langsmith_tracing}")
        print(f"  â„¹ï¸  LANGSMITH_PROJECT: {langsmith_project}")
        print("\n  ğŸ’¡ LangSmithëŠ” ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ, í”„ë¡œë•ì…˜ì—ì„œëŠ” ê¶Œì¥í•©ë‹ˆë‹¤.")
        print("     ì„¤ì •í•˜ì§€ ì•Šì•„ë„ AgentëŠ” ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.")

    print("\n" + "-" * 70)


# ============================================================================
# ì˜ˆì œ 3: LangSmith í”„ë¡œì íŠ¸ ê°œë…
# ============================================================================

def example_3_projects():
    """LangSmith í”„ë¡œì íŠ¸ ê°œë…"""
    print("\n" + "=" * 70)
    print("ğŸ“Œ ì˜ˆì œ 3: LangSmith í”„ë¡œì íŠ¸")
    print("=" * 70)

    print("""
ğŸ“ í”„ë¡œì íŠ¸ (Project)ë€?

ì •ì˜:
  íŠ¸ë ˆì´ìŠ¤ë¥¼ ê·¸ë£¹í™”í•˜ëŠ” ë‹¨ìœ„
  ì˜ˆ: "chatbot-dev", "chatbot-prod"

í”„ë¡œì íŠ¸ êµ¬ì¡° ì˜ˆì‹œ:
  mycompany/
  â”œâ”€â”€ chatbot-dev         (ê°œë°œ í™˜ê²½)
  â”œâ”€â”€ chatbot-staging     (ìŠ¤í…Œì´ì§•)
  â””â”€â”€ chatbot-production  (í”„ë¡œë•ì…˜)

í™˜ê²½ë³„ ë¶„ë¦¬:
  # ê°œë°œ
  LANGSMITH_PROJECT=myapp-dev

  # ìŠ¤í…Œì´ì§•
  LANGSMITH_PROJECT=myapp-staging

  # í”„ë¡œë•ì…˜
  LANGSMITH_PROJECT=myapp-prod

ì½”ë“œì—ì„œ ë™ì  ì„¤ì •:
  ```python
  import os
  os.environ["LANGSMITH_PROJECT"] = "my-custom-project"
  ```

ğŸ’¡ ê¶Œì¥ ì‚¬í•­:
  â€¢ í™˜ê²½ë³„ë¡œ í”„ë¡œì íŠ¸ ë¶„ë¦¬
  â€¢ ëª…í™•í•œ ë„¤ì´ë° ê·œì¹™
  â€¢ íŒ€ì› ê°„ í”„ë¡œì íŠ¸ ê³µìœ 
    """)


# ============================================================================
# ì˜ˆì œ 4: ì²« ë²ˆì§¸ íŠ¸ë ˆì´ìŠ¤
# ============================================================================

def example_4_first_trace():
    """ì²« ë²ˆì§¸ íŠ¸ë ˆì´ìŠ¤ ìƒì„±"""
    print("\n" + "=" * 70)
    print("ğŸ“Œ ì˜ˆì œ 4: ì²« ë²ˆì§¸ íŠ¸ë ˆì´ìŠ¤ ìƒì„±")
    print("=" * 70)

    @tool
    def calculate_sum(a: int, b: int) -> int:
        """ë‘ ìˆ«ìë¥¼ ë”í•©ë‹ˆë‹¤."""
        return a + b

    @tool
    def get_info(topic: str) -> str:
        """ì£¼ì œì— ëŒ€í•œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤."""
        return f"{topic}ì— ëŒ€í•œ ì •ë³´ì…ë‹ˆë‹¤."

    # Agent ìƒì„±
    agent = create_agent(
        model="gpt-4o-mini",
        tools=[calculate_sum, get_info],
    )

    print("\nğŸ”¹ Agent ì‹¤í–‰:")
    print("-" * 70)

    user_message = "10ê³¼ 20ì„ ë”í•˜ê³ , ê²°ê³¼ì— ëŒ€í•œ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”."
    print(f"ğŸ‘¤ ì‚¬ìš©ì: {user_message}\n")

    # Agent ì‹¤í–‰ (ìë™ìœ¼ë¡œ LangSmithì— íŠ¸ë ˆì´ìŠ¤ ì „ì†¡)
    response = agent.invoke({
        "messages": [{"role": "user", "content": user_message}]
    })

    print(f"ğŸ¤– Agent: {response['messages'][-1].content}\n")

    print("-" * 70)

    if os.getenv("LANGSMITH_API_KEY"):
        project = os.getenv("LANGSMITH_PROJECT", "default")
        print("âœ… íŠ¸ë ˆì´ìŠ¤ê°€ LangSmithì— ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!")
        print(f"   í”„ë¡œì íŠ¸: {project}")
        print(f"   í™•ì¸: https://smith.langchain.com")
        print("\nğŸ’¡ LangSmith ëŒ€ì‹œë³´ë“œì—ì„œ ë‹¤ìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:")
        print("   â€¢ Agentê°€ í˜¸ì¶œí•œ Tool")
        print("   â€¢ LLM ì…ë ¥/ì¶œë ¥")
        print("   â€¢ ì‹¤í–‰ ì‹œê°„")
        print("   â€¢ ë¹„ìš©")
    else:
        print("â„¹ï¸  LANGSMITH_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ë¡œì»¬ì—ì„œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.")
        print("   LangSmithë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ .envì— API í‚¤ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.")


# ============================================================================
# ì˜ˆì œ 5: LangSmith í™œìš© íŒ
# ============================================================================

def example_5_tips():
    """LangSmith í™œìš© íŒ"""
    print("\n" + "=" * 70)
    print("ğŸ“Œ ì˜ˆì œ 5: LangSmith í™œìš© íŒ")
    print("=" * 70)

    print("""
ğŸ¯ LangSmith í™œìš© íŒ:

1ï¸âƒ£ ë©”íƒ€ë°ì´í„° ì¶”ê°€:
   ```python
   from langsmith import traceable

   @traceable(
       name="custom_function",
       metadata={"version": "1.0", "env": "prod"}
   )
   def my_function():
       pass
   ```

2ï¸âƒ£ íƒœê·¸ í™œìš©:
   ```python
   agent.invoke(
       input,
       config={
           "tags": ["user-123", "feature-chatbot"],
           "metadata": {"session_id": "abc"}
       }
   )
   ```

3ï¸âƒ£ ìƒ˜í”Œë§ (Sampling):
   ```python
   # 10% íŠ¸ë ˆì´ì‹± (í”„ë¡œë•ì…˜ì—ì„œ ë¹„ìš© ì ˆê°)
   os.environ["LANGSMITH_TRACING_SAMPLING_RATE"] = "0.1"
   ```

4ï¸âƒ£ ì˜¤ë¥˜ ì¶”ì :
   â€¢ LangSmithëŠ” ìë™ìœ¼ë¡œ ì˜¤ë¥˜ ê¸°ë¡
   â€¢ ëŒ€ì‹œë³´ë“œì—ì„œ ì‹¤íŒ¨í•œ ì‹¤í–‰ë§Œ í•„í„°ë§ ê°€ëŠ¥

5ï¸âƒ£ ë¹„ìš© ëª¨ë‹ˆí„°ë§:
   â€¢ ê° íŠ¸ë ˆì´ìŠ¤ì˜ í† í° ì‚¬ìš©ëŸ‰ ì¶”ì 
   â€¢ ë¹„ìš©ì´ ë†’ì€ ì‹¤í–‰ íŒŒì•…
   â€¢ í”„ë¡¬í”„íŠ¸ ìµœì í™” í¬ì¸íŠ¸ ë°œê²¬

6ï¸âƒ£ í”„ë¡¬í”„íŠ¸ ìµœì í™”:
   â€¢ ì‹¤ì œ ì‚¬ìš©ì ì§ˆë¬¸ ë¶„ì„
   â€¢ ì‹¤íŒ¨ ì¼€ì´ìŠ¤ í•™ìŠµ
   â€¢ A/B í…ŒìŠ¤íŠ¸

7ï¸âƒ£ íŒ€ í˜‘ì—…:
   â€¢ íŒ€ì› ì´ˆëŒ€
   â€¢ í”„ë¡œì íŠ¸ ê³µìœ 
   â€¢ ì£¼ì„ ë° í”¼ë“œë°±

ğŸ’¡ í”„ë¡œë•ì…˜ ì²´í¬ë¦¬ìŠ¤íŠ¸:
  âœ… í™˜ê²½ë³„ í”„ë¡œì íŠ¸ ë¶„ë¦¬
  âœ… ì ì ˆí•œ ìƒ˜í”Œë§ ì„¤ì •
  âœ… íƒœê·¸ ë° ë©”íƒ€ë°ì´í„° í™œìš©
  âœ… ì•Œë¦¼ ì„¤ì • (ì˜¤ë¥˜ ë°œìƒ ì‹œ)
  âœ… ì •ê¸°ì ì¸ ëŒ€ì‹œë³´ë“œ ê²€í† 
    """)


# ============================================================================
# ë©”ì¸ ì‹¤í–‰
# ============================================================================

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    print("\n" + "=" * 70)
    print("ğŸ“ LangChain AI Agent ë§ˆìŠ¤í„° êµì•ˆ")
    print("ğŸ“– Part 10: ë°°í¬ì™€ ê´€ì¸¡ì„± - LangSmith ì„¤ì •")
    print("=" * 70 + "\n")

    # ì˜ˆì œ ì‹¤í–‰
    example_1_langsmith_intro()
    input("\nâ ê³„ì†í•˜ë ¤ë©´ Enterë¥¼ ëˆ„ë¥´ì„¸ìš”...")

    example_2_environment_setup()
    input("\nâ ê³„ì†í•˜ë ¤ë©´ Enterë¥¼ ëˆ„ë¥´ì„¸ìš”...")

    example_3_projects()
    input("\nâ ê³„ì†í•˜ë ¤ë©´ Enterë¥¼ ëˆ„ë¥´ì„¸ìš”...")

    example_4_first_trace()
    input("\nâ ê³„ì†í•˜ë ¤ë©´ Enterë¥¼ ëˆ„ë¥´ì„¸ìš”...")

    example_5_tips()

    # ë§ˆë¬´ë¦¬
    print("\n" + "=" * 70)
    print("ğŸ‰ Part 10-01: LangSmith ì„¤ì •ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!")
    print("=" * 70)
    print("\nğŸ’¡ ë‹¤ìŒ ë‹¨ê³„:")
    print("  1. 02_tracing.py - íŠ¸ë ˆì´ì‹± ì‹¬í™”")
    print("  2. 03_testing.py - ìë™í™” í…ŒìŠ¤íŠ¸")
    print("  3. 04_evaluation.py - í‰ê°€ ë° ë²¤ì¹˜ë§ˆí¬")
    print("\nğŸ“š í•µì‹¬ ìš”ì•½:")
    print("  â€¢ LangSmith: LLM ì•± ê´€ì¸¡ì„± í”Œë«í¼")
    print("  â€¢ íŠ¸ë ˆì´ì‹±, í‰ê°€, ëª¨ë‹ˆí„°ë§ í†µí•©")
    print("  â€¢ í™˜ê²½ ë³€ìˆ˜ë¡œ ê°„ë‹¨íˆ ì„¤ì •")
    print("  â€¢ í”„ë¡œë•ì…˜ì—ì„œ í•„ìˆ˜ ë„êµ¬")
    print("  â€¢ ë¬´ë£Œ í”Œëœìœ¼ë¡œ ì‹œì‘ ê°€ëŠ¥")
    print("\n" + "=" * 70 + "\n")


# ============================================================================
# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
# ============================================================================

if __name__ == "__main__":
    main()


# ============================================================================
# ğŸ“š ì¶”ê°€ í•™ìŠµ í¬ì¸íŠ¸
# ============================================================================
#
# 1. LangSmith ê³ ê¸‰ ê¸°ëŠ¥:
#    - Custom Evaluators
#    - Datasets & Examples
#    - Annotations
#    - Feedback
#
# 2. ëŒ€ì•ˆ ë„êµ¬:
#    - LangFuse (ì˜¤í”ˆì†ŒìŠ¤)
#    - Phoenix (Arize AI)
#    - Weights & Biases
#
# 3. ë¹„ìš© ìµœì í™”:
#    - ìƒ˜í”Œë§ ì „ëµ
#    - ë°ì´í„° ë³´ì¡´ ê¸°ê°„
#    - í•„í„°ë§ ê·œì¹™
#
# ============================================================================
