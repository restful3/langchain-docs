"""
================================================================================
Project 1: ë‚ ì”¨ ë¹„ì„œ Agent - ë©”ì¸ í”„ë¡œê·¸ë¨
================================================================================

íŒŒì¼ëª…: main.py
ì„¤ëª…: OpenWeatherMap APIë¥¼ ì‚¬ìš©í•˜ëŠ” ëŒ€í™”í˜• ë‚ ì”¨ ë¹„ì„œ Agent

ì‹¤í–‰ ë°©ë²•:
    python main.py

================================================================================
"""

import os
from dotenv import load_dotenv
from langchain.agents import create_agent
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage

from tools import get_weather, get_forecast, compare_weather, check_api_key


# ============================================================================
# í™˜ê²½ ì„¤ì •
# ============================================================================

load_dotenv()

# ============================================================================
# Agent ì„¤ì •
# ============================================================================

SYSTEM_PROMPT = """
ë‹¹ì‹ ì€ ì¹œì ˆí•˜ê³  ìœ ìš©í•œ ë‚ ì”¨ ë¹„ì„œì…ë‹ˆë‹¤. ğŸ˜Š

**ì—­í• :**
- ì‚¬ìš©ìê°€ ìš”ì²­í•œ ë„ì‹œì˜ ë‚ ì”¨ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤
- ë‚ ì”¨ì— ë§ëŠ” ì‹¤ìš©ì ì¸ ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤
- ì¹œê·¼í•˜ê³  ëŒ€í™”í•˜ê¸° ì‰¬ìš´ í†¤ì„ ìœ ì§€í•©ë‹ˆë‹¤

**ì¡°ì–¸ ê°€ì´ë“œ:**
- 15Â°C ì´í•˜: ê²‰ì˜·ì„ ì±™ê¸°ë¼ê³  ì¡°ì–¸
- 25Â°C ì´ìƒ: ì‹œì›í•œ ì˜·ì°¨ë¦¼ ì¶”ì²œ
- ë¹„ ì˜ˆìƒ: ìš°ì‚° ì±™ê¸°ê¸° ê¶Œìœ 
- ë§‘ì€ ë‚ : ì•¼ì™¸ í™œë™ ì¶”ì²œ

**ì‘ë‹µ ìŠ¤íƒ€ì¼:**
- ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•´ì„œ ì¹œê·¼í•¨ì„ í‘œí˜„
- ì§§ê³  ëª…í™•í•˜ê²Œ ë‹µë³€
- ì¶”ê°€ ì§ˆë¬¸ì´ ìˆëŠ”ì§€ ë¬¼ì–´ë³´ê¸°
""".strip()


def create_weather_agent():
    """
    ë‚ ì”¨ ë¹„ì„œ Agentë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

    Returns:
        ì„¤ì •ëœ Agent ê°ì²´
    """
    # LLM ì´ˆê¸°í™”
    model = ChatOpenAI(
        model="gpt-4o-mini",
        temperature=0.7,  # ì•½ê°„ì˜ ì°½ì˜ì„±
    )

    # Agent ìƒì„±
    agent = create_agent(
        model=model,
        tools=[
            get_weather,      # í˜„ì¬ ë‚ ì”¨ ì¡°íšŒ
            compare_weather,  # ë„ì‹œ ë¹„êµ (ë„ì „ ê³¼ì œ)
            # get_forecast,   # 5ì¼ ì˜ˆë³´ (ë¯¸êµ¬í˜„)
        ],
        system_prompt=SYSTEM_PROMPT,
    )

    return agent


# ============================================================================
# ëŒ€í™” ì¸í„°í˜ì´ìŠ¤
# ============================================================================

def print_welcome():
    """í™˜ì˜ ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤."""
    print("=" * 70)
    print("ğŸŒ¤ï¸  ë‚ ì”¨ ë¹„ì„œ Agentì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!")
    print("=" * 70)
    print()
    print("ğŸ“ ì „ ì„¸ê³„ ë„ì‹œì˜ ë‚ ì”¨ ì •ë³´ë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.")
    print()
    print("ğŸ’¬ ì˜ˆì‹œ ì§ˆë¬¸:")
    print("   â€¢ ì„œìš¸ ë‚ ì”¨ ì–´ë•Œ?")
    print("   â€¢ ë‰´ìš•ì€ ì§€ê¸ˆ ëª‡ ë„ì•¼?")
    print("   â€¢ ë¶€ì‚°ì´ë‘ ëŒ€êµ¬ ë‚ ì”¨ ë¹„êµí•´ì¤˜")
    print()
    print("âŒ¨ï¸  'ì¢…ë£Œ', 'quit', 'exit'ë¥¼ ì…ë ¥í•˜ë©´ í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë©ë‹ˆë‹¤.")
    print("=" * 70)
    print()


def chat_loop(agent):
    """
    ëŒ€í™” ë£¨í”„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

    Args:
        agent: ë‚ ì”¨ ë¹„ì„œ Agent
    """
    print_welcome()

    while True:
        # ì‚¬ìš©ì ì…ë ¥
        try:
            user_input = input("ğŸ‘¤ You: ").strip()
        except (KeyboardInterrupt, EOFError):
            print("\n\nğŸ‘‹ ì•ˆë…•íˆ ê°€ì„¸ìš”!")
            break

        # ì¢…ë£Œ ëª…ë ¹ í™•ì¸
        if user_input.lower() in ["ì¢…ë£Œ", "quit", "exit", "q"]:
            print("ğŸ‘‹ ì•ˆë…•íˆ ê°€ì„¸ìš”!")
            break

        # ë¹ˆ ì…ë ¥ ë¬´ì‹œ
        if not user_input:
            continue

        # Agent ì‹¤í–‰
        try:
            result = agent.invoke({
                "messages": [HumanMessage(content=user_input)]
            })

            # ì‘ë‹µ ì¶œë ¥
            response = result["messages"][-1].content
            print(f"\nğŸ¤– Agent: {response}\n")

        except Exception as e:
            print(f"\nâŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
            print("ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n")


# ============================================================================
# ë‹¨ì¼ ì§ˆë¬¸ ëª¨ë“œ
# ============================================================================

def ask_once(agent, question: str):
    """
    ë‹¨ì¼ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ë°›ìŠµë‹ˆë‹¤.

    Args:
        agent: ë‚ ì”¨ ë¹„ì„œ Agent
        question: ì§ˆë¬¸ ë‚´ìš©

    Returns:
        Agentì˜ ì‘ë‹µ
    """
    result = agent.invoke({
        "messages": [HumanMessage(content=question)]
    })

    return result["messages"][-1].content


# ============================================================================
# ë©”ì¸ í•¨ìˆ˜
# ============================================================================

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""

    # 1. API í‚¤ í™•ì¸
    if not os.getenv("OPENAI_API_KEY"):
        print("âŒ ì˜¤ë¥˜: OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        print("ğŸ“ .env íŒŒì¼ì— ë‹¤ìŒì„ ì¶”ê°€í•˜ì„¸ìš”:")
        print("   OPENAI_API_KEY=your-openai-key")
        return

    if not check_api_key():
        print("âŒ ì˜¤ë¥˜: OPENWEATHER_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        print("ğŸ“ .env íŒŒì¼ì— ë‹¤ìŒì„ ì¶”ê°€í•˜ì„¸ìš”:")
        print("   OPENWEATHER_API_KEY=your-openweather-key")
        print()
        print("ğŸ”— ë¬´ë£Œ API í‚¤ ë°œê¸‰: https://openweathermap.org/api")
        return

    # 2. Agent ìƒì„±
    print("ğŸ”„ Agentë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘...")
    try:
        agent = create_weather_agent()
        print("âœ… Agentê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!\n")
    except Exception as e:
        print(f"âŒ Agent ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
        return

    # 3. ëŒ€í™” ì‹œì‘
    chat_loop(agent)


# ============================================================================
# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
# ============================================================================

if __name__ == "__main__":
    main()


# ============================================================================
# ğŸ“š ì¶”ê°€ í•™ìŠµ í¬ì¸íŠ¸
# ============================================================================
#
# 1. Agent ê°œì„ :
#    - ë©”ëª¨ë¦¬ ì¶”ê°€ (Part 4 í•™ìŠµ í›„)
#    - ë¯¸ë“¤ì›¨ì–´ë¡œ ë¡œê¹… ì¶”ê°€ (Part 5 í•™ìŠµ í›„)
#    - ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ (Part 9 í•™ìŠµ í›„)
#
# 2. ë„êµ¬ í™•ì¥:
#    - 5ì¼ ë‚ ì”¨ ì˜ˆë³´ (get_forecast êµ¬í˜„)
#    - ë‚ ì”¨ ì•Œë¦¼ ê¸°ëŠ¥
#    - ì—¬ëŸ¬ ë„ì‹œ í•œë²ˆì— ì¡°íšŒ
#
# 3. UX ê°œì„ :
#    - ì»¬ëŸ¬ í„°ë¯¸ë„ ì¶œë ¥ (colorama)
#    - ë‚ ì”¨ ì•„ì´ì½˜ í‘œì‹œ
#    - GUI ì¸í„°í˜ì´ìŠ¤ (Streamlit, Gradio)
#
# ============================================================================
