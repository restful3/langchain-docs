# ë‹¨ê¸° ë©”ëª¨ë¦¬

## ê°œìš”

ë©”ëª¨ë¦¬ëŠ” ì´ì „ ìƒí˜¸ì‘ìš©ì— ëŒ€í•œ ì •ë³´ë¥¼ ê¸°ì–µí•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤. AI Agentì˜ ê²½ìš° ì´ì „ ìƒí˜¸ì‘ìš©ì„ ê¸°ì–µí•˜ê³ , í”¼ë“œë°±ì—ì„œ í•™ìŠµí•˜ê³ , ì‚¬ìš©ì ì„ í˜¸ë„ì— ë§ì¶° ì¡°ì •í•  ìˆ˜ ìˆê²Œ í•´ì£¼ë¯€ë¡œ ë©”ëª¨ë¦¬ëŠ” ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤. Agentê°€ ìˆ˜ë§ì€ ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ê³¼ í•¨ê»˜ ë” ë³µì¡í•œ ì‘ì—…ì„ ì²˜ë¦¬í• ìˆ˜ë¡ ì´ ê¸°ëŠ¥ì€ íš¨ìœ¨ì„±ê³¼ ì‚¬ìš©ì ë§Œì¡±ë„ ëª¨ë‘ë¥¼ ìœ„í•´ í•„ìˆ˜ì ìœ¼ë¡œ ë©ë‹ˆë‹¤.

ë‹¨ê¸° ë©”ëª¨ë¦¬ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë‹¨ì¼ ìŠ¤ë ˆë“œ ë˜ëŠ” ëŒ€í™” ë‚´ì—ì„œ ì´ì „ ìƒí˜¸ì‘ìš©ì„ ê¸°ì–µí•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

> ìŠ¤ë ˆë“œëŠ” ì´ë©”ì¼ì´ ë‹¨ì¼ ëŒ€í™”ì—ì„œ ë©”ì‹œì§€ë¥¼ ê·¸ë£¹í™”í•˜ëŠ” ë°©ì‹ê³¼ ìœ ì‚¬í•˜ê²Œ ì„¸ì…˜ì—ì„œ ì—¬ëŸ¬ ìƒí˜¸ì‘ìš©ì„ ì •ë¦¬í•©ë‹ˆë‹¤.

ëŒ€í™” ì´ë ¥ì€ ê°€ì¥ ì¼ë°˜ì ì¸ ë‹¨ê¸° ë©”ëª¨ë¦¬ í˜•íƒœì…ë‹ˆë‹¤. ê¸´ ëŒ€í™”ëŠ” ì˜¤ëŠ˜ë‚ ì˜ LLMì— ë„ì „ì´ ë©ë‹ˆë‹¤. ì „ì²´ ì´ë ¥ì´ LLMì˜ ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš°ì— ë§ì§€ ì•Šì•„ ì»¨í…ìŠ¤íŠ¸ ì†ì‹¤ ë˜ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ëª¨ë¸ì´ ì „ì²´ ì»¨í…ìŠ¤íŠ¸ ê¸¸ì´ë¥¼ ì§€ì›í•˜ë”ë¼ë„ ëŒ€ë¶€ë¶„ì˜ LLMì€ ì—¬ì „íˆ ê¸´ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì„±ëŠ¥ì´ ë–¨ì–´ì§‘ë‹ˆë‹¤. ì´ë“¤ì€ ì˜¤ë˜ë˜ì—ˆê±°ë‚˜ ì£¼ì œì—ì„œ ë²—ì–´ë‚œ ì½˜í…ì¸ ì— ì˜í•´ "ì‚°ë§Œí•´"ì§€ë©´ì„œ ë™ì‹œì— ë” ëŠë¦° ì‘ë‹µ ì‹œê°„ê³¼ ë†’ì€ ë¹„ìš©ìœ¼ë¡œ ê³ í†µë°›ìŠµë‹ˆë‹¤.

ì±„íŒ… ëª¨ë¸ì€ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ë½í•˜ë©°, ì—¬ê¸°ì—ëŠ” ì§€ì¹¨(ì‹œìŠ¤í…œ ë©”ì‹œì§€)ê³¼ ì…ë ¥(ì¸ê°„ ë©”ì‹œì§€)ì´ í¬í•¨ë©ë‹ˆë‹¤. ì±„íŒ… ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” ë©”ì‹œì§€ê°€ ì¸ê°„ ì…ë ¥ê³¼ ëª¨ë¸ ì‘ë‹µ ì‚¬ì´ì—ì„œ ë²ˆê°ˆì•„ ë‚˜íƒ€ë‚˜ë©°, ì‹œê°„ì´ ì§€ë‚˜ë©´ì„œ ê³„ì† ê¸¸ì–´ì§€ëŠ” ë©”ì‹œì§€ ëª©ë¡ì´ ìƒê¹ë‹ˆë‹¤. ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš°ê°€ ì œí•œë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ë§ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì˜¤ë˜ëœ ì •ë³´ë¥¼ ì œê±°í•˜ê±°ë‚˜ "ìŠë„ë¡" í•˜ëŠ” ê¸°ìˆ ì„ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ì´ì ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì‚¬ìš© ë°©ë²•

Agentì— ë‹¨ê¸° ë©”ëª¨ë¦¬(ìŠ¤ë ˆë“œ ìˆ˜ì¤€ ì§€ì†ì„±)ë¥¼ ì¶”ê°€í•˜ë ¤ë©´ Agentë¥¼ ìƒì„±í•  ë•Œ checkpointerë¥¼ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.

> LangChainì˜ AgentëŠ” Agentì˜ ìƒíƒœì˜ ì¼ë¶€ë¡œ ë‹¨ê¸° ë©”ëª¨ë¦¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
> ì´ë“¤ì„ ê·¸ë˜í”„ì˜ ìƒíƒœì— ì €ì¥í•¨ìœ¼ë¡œì¨ AgentëŠ” ì„œë¡œ ë‹¤ë¥¸ ìŠ¤ë ˆë“œ ê°„ ë¶„ë¦¬ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì£¼ì–´ì§„ ëŒ€í™”ì— ëŒ€í•œ ì „ì²´ ì»¨í…ìŠ¤íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
>
> ìƒíƒœëŠ” checkpointerë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤(ë˜ëŠ” ë©”ëª¨ë¦¬)ì— ìœ ì§€ë˜ë¯€ë¡œ ìŠ¤ë ˆë“œë¥¼ ì–¸ì œë“ ì§€ ì¬ê°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
>
> ë‹¨ê¸° ë©”ëª¨ë¦¬ëŠ” Agentê°€ í˜¸ì¶œë˜ê±°ë‚˜ ë‹¨ê³„(ë„êµ¬ í˜¸ì¶œ ê°™ì€)ê°€ ì™„ë£Œë  ë•Œ ì—…ë°ì´íŠ¸ë˜ë©°, ìƒíƒœëŠ” ê° ë‹¨ê³„ì˜ ì‹œì‘ì— ì½í™ë‹ˆë‹¤.

```python
from langchain.agents import create_agent
from langgraph.checkpoint.memory import InMemorySaver


agent = create_agent(
    "gpt-5",
    tools=[get_user_info],
    checkpointer=InMemorySaver(),
)

agent.invoke(
    {"messages": [{"role": "user", "content": "Hi! My name is Bob."}]},
    {"configurable": {"thread_id": "1"}},
)
```

### í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ

í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ë¡œ ì§€ì›ë˜ëŠ” checkpointerë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:

```bash
pip install langgraph-checkpoint-postgres
```

```python
from langchain.agents import create_agent

from langgraph.checkpoint.postgres import PostgresSaver


DB_URI = "postgresql://postgres:postgres@localhost:5442/postgres?sslmode=disable"
with PostgresSaver.from_conn_string(DB_URI) as checkpointer:
    checkpointer.setup() # PostgresSqlì—ì„œ í…Œì´ë¸” ìë™ ìƒì„±
    agent = create_agent(
        "gpt-5",
        tools=[get_user_info],
        checkpointer=checkpointer,
    )
```

> SQLite, Postgres, Azure Cosmos DBë¥¼ í¬í•¨í•œ ë” ë§ì€ checkpointer ì˜µì…˜ì€ ì§€ì†ì„± ë¬¸ì„œì˜ checkpointer ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡ì„ ì°¸ì¡°í•˜ì„¸ìš”.

## Agent ë©”ëª¨ë¦¬ ì‚¬ìš©ì ì •ì˜

ê¸°ë³¸ì ìœ¼ë¡œ AgentëŠ” `AgentState`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¨ê¸° ë©”ëª¨ë¦¬ë¥¼ ê´€ë¦¬í•˜ë©°, íŠ¹íˆ `messages` í‚¤ë¥¼ í†µí•œ ëŒ€í™” ì´ë ¥ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.

`AgentState`ë¥¼ í™•ì¥í•˜ì—¬ ì¶”ê°€ í•„ë“œë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ì ì •ì˜ ìƒíƒœ ìŠ¤í‚¤ë§ˆëŠ” `state_schema` ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ `create_agent`ì— ì „ë‹¬ë©ë‹ˆë‹¤.

```python
from langchain.agents import create_agent, AgentState
from langgraph.checkpoint.memory import InMemorySaver


class CustomAgentState(AgentState):
    user_id: str
    preferences: dict

agent = create_agent(
    "gpt-5",
    tools=[get_user_info],
    state_schema=CustomAgentState,
    checkpointer=InMemorySaver(),
)

# ì‚¬ìš©ì ì •ì˜ ìƒíƒœëŠ” invokeì—ì„œ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
result = agent.invoke(
    {
        "messages": [{"role": "user", "content": "Hello"}],
        "user_id": "user_123",
        "preferences": {"theme": "dark"}
    },
    {"configurable": {"thread_id": "1"}})
```

## ì¼ë°˜ì ì¸ íŒ¨í„´

ë‹¨ê¸° ë©”ëª¨ë¦¬ê°€ í™œì„±í™”ëœ ìƒíƒœì—ì„œ ê¸´ ëŒ€í™”ëŠ” LLMì˜ ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš°ë¥¼ ì´ˆê³¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¼ë°˜ì ì¸ ì†”ë£¨ì…˜ì€:

| | |
| :--- | :--- |
| **âœ‚ï¸ ë©”ì‹œì§€ íŠ¸ë¦¬ë°**<br>ì²« ë²ˆì§¸ ë˜ëŠ” ë§ˆì§€ë§‰ Nê°œ ë©”ì‹œì§€ ì œê±°(LLMì„ í˜¸ì¶œí•˜ê¸° ì „) | **ğŸ—‘ï¸ ë©”ì‹œì§€ ì‚­ì œ**<br>LangGraph ìƒíƒœì—ì„œ ë©”ì‹œì§€ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œ |
| **ğŸ“š ë©”ì‹œì§€ ìš”ì•½**<br>ì´ì „ ë©”ì‹œì§€ ì´ë ¥ì„ ìš”ì•½í•˜ê³  ìš”ì•½ìœ¼ë¡œ êµì²´ | **âš™ï¸ ì‚¬ìš©ì ì •ì˜ ì „ëµ**<br>ì‚¬ìš©ì ì •ì˜ ì „ëµ(ì˜ˆ: ë©”ì‹œì§€ í•„í„°ë§ ë“±) |

ì´ë¥¼ í†µí•´ AgentëŠ” LLMì˜ ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš°ë¥¼ ì´ˆê³¼í•˜ì§€ ì•Šìœ¼ë©´ì„œ ëŒ€í™”ë¥¼ ì¶”ì í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë©”ì‹œì§€ íŠ¸ë¦¬ë°

ëŒ€ë¶€ë¶„ì˜ LLMì€ ìµœëŒ€ ì§€ì› ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš°ë¥¼ ê°–ìŠµë‹ˆë‹¤(í† í° ë‹¨ìœ„ë¡œ ê³„ì‚°ë¨).

ë©”ì‹œì§€ë¥¼ ì–¸ì œ ìë¥¼ì§€ ê²°ì •í•˜ëŠ” í•œ ê°€ì§€ ë°©ë²•ì€ ë©”ì‹œì§€ ì´ë ¥ì—ì„œ í† í°ì„ ì„¸ê³  ê·¸ ì œí•œì— ì ‘ê·¼í•  ë•Œë§ˆë‹¤ ìë¥´ëŠ” ê²ƒì…ë‹ˆë‹¤. LangChainì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° `trim messages` ìœ í‹¸ë¦¬í‹°ë¥¼ ì‚¬ìš©í•˜ê³  ëª©ë¡ì—ì„œ ìœ ì§€í•  í† í° ìˆ˜ì™€ ê²½ê³„ ì²˜ë¦¬ ì „ëµ(ì˜ˆ: ë§ˆì§€ë§‰ `max_tokens` ìœ ì§€)ì„ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Agentì—ì„œ ë©”ì‹œì§€ ì´ë ¥ì„ íŠ¸ë¦¬ë°í•˜ë ¤ë©´ `@before_model` Middleware ë°ì½”ë ˆì´í„°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:

```python
from langchain.messages import RemoveMessage
from langgraph.graph.message import REMOVE_ALL_MESSAGES
from langgraph.checkpoint.memory import InMemorySaver
from langchain.agents import create_agent, AgentState
from langchain.agents.middleware import before_model
from langgraph.runtime import Runtime
from langchain_core.runnables import RunnableConfig
from typing import Any


@before_model
def trim_messages(state: AgentState, runtime: Runtime) -> dict[str, Any] | None:
    """ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš°ì— ë§ë„ë¡ ìµœê·¼ ëª‡ ê°œì˜ ë©”ì‹œì§€ë§Œ ìœ ì§€í•©ë‹ˆë‹¤."""
    messages = state["messages"]

    if len(messages) <= 3:
        return None  # ë³€ê²½ ì‚¬í•­ ì—†ìŒ

    first_msg = messages[0]
    recent_messages = messages[-3:] if len(messages) % 2 == 0 else messages[-4:]
    new_messages = [first_msg] + recent_messages

    return {
        "messages": [
            RemoveMessage(id=REMOVE_ALL_MESSAGES),
            *new_messages
        ]
    }

agent = create_agent(
    your_model_here,
    tools=your_tools_here,
    middleware=[trim_messages],
    checkpointer=InMemorySaver(),
)

config: RunnableConfig = {"configurable": {"thread_id": "1"}}

agent.invoke({"messages": "hi, my name is bob"}, config)
agent.invoke({"messages": "write a short poem about cats"}, config)
agent.invoke({"messages": "now do the same but for dogs"}, config)
final_response = agent.invoke({"messages": "what's my name?"}, config)

final_response["messages"][-1].pretty_print()
"""
================================== Ai Message ==================================

Your name is Bob. You told me that earlier.
If you'd like me to call you a nickname or use a different name, just say the word.
"""
```

### ë©”ì‹œì§€ ì‚­ì œ

ê·¸ë˜í”„ ìƒíƒœì—ì„œ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì—¬ ë©”ì‹œì§€ ì´ë ¥ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ëŠ” íŠ¹ì • ë©”ì‹œì§€ë¥¼ ì œê±°í•˜ê±°ë‚˜ ì „ì²´ ë©”ì‹œì§€ ì´ë ¥ì„ ì§€ìš°ë ¤ê³  í•  ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.
ê·¸ë˜í”„ ìƒíƒœì—ì„œ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ë ¤ë©´ `RemoveMessage`ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
`RemoveMessage`ê°€ ì‘ë™í•˜ë ¤ë©´ `add_messages` ë¦¬ë“€ì„œê°€ ìˆëŠ” ìƒíƒœ í‚¤ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
ê¸°ë³¸ `AgentState`ëŠ” ì´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

íŠ¹ì • ë©”ì‹œì§€ë¥¼ ì œê±°í•˜ë ¤ë©´:

```python
from langchain.messages import RemoveMessage

def delete_messages(state):
    messages = state["messages"]
    if len(messages) > 2:
        # ê°€ì¥ ì´ë¥¸ ë‘ ê°œì˜ ë©”ì‹œì§€ ì œê±°
        return {"messages": [RemoveMessage(id=m.id) for m in messages[:2]]}
```

ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì œê±°í•˜ë ¤ë©´:

```python
from langgraph.graph.message import REMOVE_ALL_MESSAGES

def delete_messages(state):
    return {"messages": [RemoveMessage(id=REMOVE_ALL_MESSAGES)]}
```

> ë©”ì‹œì§€ë¥¼ ì‚­ì œí•  ë•Œ ê²°ê³¼ ë©”ì‹œì§€ ì´ë ¥ì´ ìœ íš¨í•œì§€ í™•ì¸í•˜ì„¸ìš”. ì‚¬ìš© ì¤‘ì¸ LLM ê³µê¸‰ìì˜ ì œí•œ ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”. ì˜ˆë¥¼ ë“¤ì–´:
> *   ì¼ë¶€ ê³µê¸‰ìëŠ” ë©”ì‹œì§€ ì´ë ¥ì´ ì‚¬ìš©ì ë©”ì‹œì§€ë¡œ ì‹œì‘ë˜ê¸°ë¥¼ ê¸°ëŒ€í•©ë‹ˆë‹¤
> *   ëŒ€ë¶€ë¶„ì˜ ê³µê¸‰ìëŠ” ë„êµ¬ í˜¸ì¶œì´ ìˆëŠ” ì¡°ìˆ˜ ë©”ì‹œì§€ ë’¤ì— í•´ë‹¹ ë„êµ¬ ê²°ê³¼ ë©”ì‹œì§€ê°€ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.

```python
from langchain.messages import RemoveMessage
from langchain.agents import create_agent, AgentState
from langchain.agents.middleware import after_model
from langgraph.checkpoint.memory import InMemorySaver
from langgraph.runtime import Runtime
from langchain_core.runnables import RunnableConfig


@after_model
def delete_old_messages(state: AgentState, runtime: Runtime) -> dict | None:
    """ëŒ€í™”ë¥¼ ê´€ë¦¬ ê°€ëŠ¥í•˜ê²Œ ìœ ì§€í•˜ê¸° ìœ„í•´ ì˜¤ë˜ëœ ë©”ì‹œì§€ë¥¼ ì œê±°í•©ë‹ˆë‹¤."""
    messages = state["messages"]
    if len(messages) > 2:
        # ê°€ì¥ ì´ë¥¸ ë‘ ê°œì˜ ë©”ì‹œì§€ ì œê±°
        return {"messages": [RemoveMessage(id=m.id) for m in messages[:2]]}
    return None


agent = create_agent(
    "gpt-5-nano",
    tools=[],
    system_prompt="Please be concise and to the point.",
    middleware=[delete_old_messages],
    checkpointer=InMemorySaver(),
)

config: RunnableConfig = {"configurable": {"thread_id": "1"}}

for event in agent.stream(
    {"messages": [{"role": "user", "content": "hi! I'm bob"}]},
    config,
    stream_mode="values",
):
    print([(message.type, message.content) for message in event["messages"]])

for event in agent.stream(
    {"messages": [{"role": "user", "content": "what's my name?"}]},
    config,
    stream_mode="values",
):
    print([(message.type, message.content) for message in event["messages"]])
```
```text
[('human', "hi! I'm bob")]
[('human', "hi! I'm bob"), ('ai', 'Hi Bob! Nice to meet you. How can I help you today? I can answer questions, brainstorm ideas, draft text, explain things, or help with code.')]
[('human', "hi! I'm bob"), ('ai', 'Hi Bob! Nice to meet you. How can I help you today? I can answer questions, brainstorm ideas, draft text, explain things, or help with code.'), ('human', "what's my name?")]
[('human', "hi! I'm bob"), ('ai', 'Hi Bob! Nice to meet you. How can I help you today? I can answer questions, brainstorm ideas, draft text, explain things, or help with code.'), ('human', "what's my name?"), ('ai', 'Your name is Bob. How can I help you today, Bob?')]
[('human', "what's my name?"), ('ai', 'Your name is Bob. How can I help you today, Bob?')]
```

### ë©”ì‹œì§€ ìš”ì•½

ìœ„ì—ì„œ ë³´ì¸ ë©”ì‹œì§€ íŠ¸ë¦¬ë° ë˜ëŠ” ì œê±°ì˜ ë¬¸ì œëŠ” ë©”ì‹œì§€ íë¥¼ ì‚­ì œí•˜ë©´ì„œ ì •ë³´ë¥¼ ìƒì„ ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ ë•Œë¬¸ì— ì¼ë¶€ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ì±„íŒ… ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ë©”ì‹œì§€ ì´ë ¥ì„ ìš”ì•½í•˜ëŠ” ë³´ë‹¤ ì •êµí•œ ì ‘ê·¼ ë°©ì‹ìœ¼ë¡œë¶€í„° ì´ì ì„ ì–»ìŠµë‹ˆë‹¤.

![ë©”ì‹œì§€ ìš”ì•½](images/summary.avif)

Agentì—ì„œ ë©”ì‹œì§€ ì´ë ¥ì„ ìš”ì•½í•˜ë ¤ë©´ ë‚´ì¥ëœ `SummarizationMiddleware`ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:

```python
from langchain.agents import create_agent
from langchain.agents.middleware import SummarizationMiddleware
from langgraph.checkpoint.memory import InMemorySaver
from langchain_core.runnables import RunnableConfig


checkpointer = InMemorySaver()

agent = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[
        SummarizationMiddleware(
            model="gpt-4o-mini",
            trigger=("tokens", 4000),
            keep=("messages", 20)
        )
    ],
    checkpointer=checkpointer,
)

config: RunnableConfig = {"configurable": {"thread_id": "1"}}
agent.invoke({"messages": "hi, my name is bob"}, config)
agent.invoke({"messages": "write a short poem about cats"}, config)
agent.invoke({"messages": "now do the same but for dogs"}, config)
final_response = agent.invoke({"messages": "what's my name?"}, config)

final_response["messages"][-1].pretty_print()
"""
================================== Ai Message ==================================

Your name is Bob!
"""
```
ë” ë§ì€ êµ¬ì„± ì˜µì…˜ì€ `SummarizationMiddleware`ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

## ë©”ëª¨ë¦¬ ì ‘ê·¼

Agentì˜ ë‹¨ê¸° ë©”ëª¨ë¦¬(ìƒíƒœ)ë¥¼ ì—¬ëŸ¬ ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ì ‘ê·¼í•˜ê³  ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

### Tool(ë„êµ¬)

#### Toolì—ì„œ ë‹¨ê¸° ë©”ëª¨ë¦¬ ì½ê¸°
`runtime` ë§¤ê°œë³€ìˆ˜(`ToolRuntime`ë¡œ íƒ€ì…ë¨)ë¥¼ ì‚¬ìš©í•˜ì—¬ Toolì—ì„œ ë‹¨ê¸° ë©”ëª¨ë¦¬(ìƒíƒœ)ì— ì ‘ê·¼í•˜ì„¸ìš”.
`runtime` ë§¤ê°œë³€ìˆ˜ëŠ” ë„êµ¬ ì„œëª…ì—ì„œ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë¯€ë¡œ(ëª¨ë¸ì´ ë³´ì§€ ëª»í•¨) ë„êµ¬ëŠ” ì´ë¥¼ í†µí•´ ìƒíƒœì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
from langchain.agents import create_agent, AgentState
from langchain.tools import tool, ToolRuntime


class CustomState(AgentState):
    user_id: str

@tool
def get_user_info(
    runtime: ToolRuntime
) -> str:
    """ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤."""
    user_id = runtime.state["user_id"]
    return "User is John Smith" if user_id == "user_123" else "Unknown user"

agent = create_agent(
    model="gpt-5-nano",
    tools=[get_user_info],
    state_schema=CustomState,
)

result = agent.invoke({
    "messages": "look up user information",
    "user_id": "user_123"
})
print(result["messages"][-1].content)
# > User is John Smith.
```

#### Toolì—ì„œ ë‹¨ê¸° ë©”ëª¨ë¦¬ ì“°ê¸°

Agentì˜ ë‹¨ê¸° ë©”ëª¨ë¦¬(ìƒíƒœ)ë¥¼ ì‹¤í–‰ ì¤‘ ìˆ˜ì •í•˜ë ¤ë©´ Toolì—ì„œ ì§ì ‘ ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ë°˜í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ëŠ” ì¤‘ê°„ ê²°ê³¼ë¥¼ ìœ ì§€í•˜ê±°ë‚˜ í›„ì† ë„êµ¬ ë˜ëŠ” í”„ë¡¬í”„íŠ¸ì—ì„œ ì •ë³´ë¥¼ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ í•˜ëŠ” ë° ìœ ìš©í•©ë‹ˆë‹¤.

```python
from langchain.tools import tool, ToolRuntime
from langchain_core.runnables import RunnableConfig
from langchain.messages import ToolMessage
from langchain.agents import create_agent, AgentState
from langgraph.types import Command
from pydantic import BaseModel


class CustomState(AgentState):
    user_name: str

class CustomContext(BaseModel):
    user_id: str

@tool
def update_user_info(
    runtime: ToolRuntime[CustomContext, CustomState],
) -> Command:
    """ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."""
    user_id = runtime.context.user_id
    name = "John Smith" if user_id == "user_123" else "Unknown user"
    return Command(update={
        "user_name": name,
        # ë©”ì‹œì§€ ì´ë ¥ ì—…ë°ì´íŠ¸
        "messages": [
            ToolMessage(
                "Successfully looked up user information",
                tool_call_id=runtime.tool_call_id
            )
        ]
    })

@tool
def greet(
    runtime: ToolRuntime[CustomContext, CustomState]
) -> str | Command:
    """ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì€ í›„ ì‚¬ìš©ìì—ê²Œ ì¸ì‚¬í•©ë‹ˆë‹¤."""
    user_name = runtime.state.get("user_name", None)
    if user_name is None:
       return Command(update={
            "messages": [
                ToolMessage(
                    "Please call the 'update_user_info' tool it will get and update the user's name.",
                    tool_call_id=runtime.tool_call_id
                )
            ]
        })
    return f"Hello {user_name}!"

agent = create_agent(
    model="gpt-5-nano",
    tools=[update_user_info, greet],
    state_schema=CustomState,
    context_schema=CustomContext,
)

agent.invoke(
    {"messages": [{"role": "user", "content": "greet the user"}]},
    context=CustomContext(user_id="user_123"),
)
```

### í”„ë¡¬í”„íŠ¸

ëŒ€í™” ì´ë ¥ ë˜ëŠ” ì‚¬ìš©ì ì •ì˜ ìƒíƒœ í•„ë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë™ì  í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” Middlewareì—ì„œ ë‹¨ê¸° ë©”ëª¨ë¦¬(ìƒíƒœ)ì— ì ‘ê·¼í•˜ì„¸ìš”.

```python
from langchain.agents import create_agent
from typing import TypedDict
from langchain.agents.middleware import dynamic_prompt, ModelRequest


class CustomContext(TypedDict):
    user_name: str


def get_weather(city: str) -> str:
    """ë„ì‹œì˜ ë‚ ì”¨ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤."""
    return f"The weather in {city} is always sunny!"


@dynamic_prompt
def dynamic_system_prompt(request: ModelRequest) -> str:
    user_name = request.runtime.context["user_name"]
    system_prompt = f"You are a helpful assistant. Address the user as {user_name}."
    return system_prompt


agent = create_agent(
    model="gpt-5-nano",
    tools=[get_weather],
    middleware=[dynamic_system_prompt],
    context_schema=CustomContext,
)

result = agent.invoke(
    {"messages": [{"role": "user", "content": "What is the weather in SF?"}]},
    context=CustomContext(user_name="John Smith"),
)
for msg in result["messages"]:
    msg.pretty_print()
```

#### ì¶œë ¥
```text
================================ Human Message =================================

What is the weather in SF?
================================== Ai Message ==================================
Tool Calls:
  get_weather (call_WFQlOGn4b2yoJrv7cih342FG)
 Call ID: call_WFQlOGn4b2yoJrv7cih342FG
  Args:
    city: San Francisco
================================= Tool Message =================================
Name: get_weather

The weather in San Francisco is always sunny!
================================== Ai Message ==================================

Hi John Smith, the weather in San Francisco is always sunny!
```

#### Model ì´ì „

ëª¨ë¸ í˜¸ì¶œ ì „ì— ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ `@before_model` Middlewareì—ì„œ ë‹¨ê¸° ë©”ëª¨ë¦¬(ìƒíƒœ)ì— ì ‘ê·¼í•˜ì„¸ìš”.

```mermaid
graph TD
    __start__ --> before_model
    before_model --> model
    model --> tools
    tools --> before_model
    model -.-> __end__
```

```python
from langchain.messages import RemoveMessage
from langgraph.graph.message import REMOVE_ALL_MESSAGES
from langgraph.checkpoint.memory import InMemorySaver
from langchain.agents import create_agent, AgentState
from langchain.agents.middleware import before_model
from langchain_core.runnables import RunnableConfig
from langgraph.runtime import Runtime
from typing import Any


@before_model
def trim_messages(state: AgentState, runtime: Runtime) -> dict[str, Any] | None:
    """ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš°ì— ë§ë„ë¡ ìµœê·¼ ëª‡ ê°œì˜ ë©”ì‹œì§€ë§Œ ìœ ì§€í•©ë‹ˆë‹¤."""
    messages = state["messages"]

    if len(messages) <= 3:
        return None  # ë³€ê²½ ì‚¬í•­ ì—†ìŒ

    first_msg = messages[0]
    recent_messages = messages[-3:] if len(messages) % 2 == 0 else messages[-4:]
    new_messages = [first_msg] + recent_messages

    return {
        "messages": [
            RemoveMessage(id=REMOVE_ALL_MESSAGES),
            *new_messages
        ]
    }


agent = create_agent(
    "gpt-5-nano",
    tools=[],
    middleware=[trim_messages],
    checkpointer=InMemorySaver()
)

config: RunnableConfig = {"configurable": {"thread_id": "1"}}

agent.invoke({"messages": "hi, my name is bob"}, config)
agent.invoke({"messages": "write a short poem about cats"}, config)
agent.invoke({"messages": "now do the same but for dogs"}, config)
final_response = agent.invoke({"messages": "what's my name?"}, config)

final_response["messages"][-1].pretty_print()
"""
================================== Ai Message ==================================

Your name is Bob. You told me that earlier.
If you'd like me to call you a nickname or use a different name, just say the word.
"""
```

#### Model ì´í›„

ëª¨ë¸ í˜¸ì¶œ í›„ì— ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ `@after_model` Middlewareì—ì„œ ë‹¨ê¸° ë©”ëª¨ë¦¬(ìƒíƒœ)ì— ì ‘ê·¼í•˜ì„¸ìš”.

```mermaid
graph TD
    __start__ --> model
    model --> after_model
    after_model -.-> tools
    tools --> model
    after_model -.-> __end__
```

```python
from langchain.messages import RemoveMessage
from langgraph.checkpoint.memory import InMemorySaver
from langchain.agents import create_agent, AgentState
from langchain.agents.middleware import after_model
from langgraph.runtime import Runtime


@after_model
def validate_response(state: AgentState, runtime: Runtime) -> dict | None:
    """ë¯¼ê°í•œ ë‹¨ì–´ê°€ í¬í•¨ëœ ë©”ì‹œì§€ë¥¼ ì œê±°í•©ë‹ˆë‹¤."""
    STOP_WORDS = ["password", "secret"]
    last_message = state["messages"][-1]
    if any(word in last_message.content for word in STOP_WORDS):
        return {"messages": [RemoveMessage(id=last_message.id)]}
    return None

agent = create_agent(
    model="gpt-5-nano",
    tools=[],
    middleware=[validate_response],
    checkpointer=InMemorySaver(),
)
```
